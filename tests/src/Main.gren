module Main exposing (main)


import Ansi exposing (width)
import Expect
import Fuzz exposing (Fuzzer)
import Test exposing (describe, fuzz2, fuzz3, test, only)
import Test.Runner.Node exposing (Program, run)


width0 : Fuzzer String
width0 =
    Fuzz.oneOfValues
        [ ""
        , Ansi.setItalic
        , Ansi.wrapItalic ""
        , Ansi.getCursorReport
        , Ansi.setBgColor Ansi.Yellow
        , Ansi.arrowDown ++ Ansi.setColor Ansi.Blue
        , Ansi.wrapUnderline (Ansi.wrapStrikeThrough "")
        ]


width5 : Fuzzer String
width5 =
    Fuzz.asciiStringOfLength 5


main : Program
main =
    run <|
        describe "width"
            [ fuzz3 width0 width0 width0 "Zero width" <| 
                \zero1 zero2 zero3 ->
                    [ width <| zero1
                    , width <| zero2 ++ ""
                    , width <| "" ++ zero3
                    , width <| zero1 ++ zero2
                    , width <| zero1 ++ "" ++ zero2
                    , width <| zero1 ++ zero2 ++ zero3
                    ]
                        |> Expect.equalArrays
                            [ 0, 0, 0, 0, 0, 0 ]

            , fuzz2 width5 width0 "Greater than zero width" <| 
                \five zero -> 
                    [ width <| five
                    , width <| zero ++ five
                    , width <| five ++ zero
                    , width <| zero ++ five ++ zero
                    , width <| Ansi.wrapColor Ansi.Green five
                    , width <| zero ++ five ++ zero ++ zero ++ five
                    ]
                        |> Expect.equalArrays
                            [ 5, 5, 5, 5, 5, 10 ]

            , test "ansi widths" <| \_ ->
                [ width <| Ansi.setItalic
                , width <| Ansi.wrapItalic ""
                , width <| Ansi.getCursorReport
                , width <| Ansi.setBgColor Ansi.Yellow
                , width <| Ansi.setColor Ansi.Blue
                , width <| Ansi.arrowDown
                , width <| Ansi.wrapUnderline ""
                , width <| Ansi.wrapStrikeThrough ""
                ]
                    |> Expect.equalArrays
                        [ 0
                        , 0
                        , 0
                        , 0
                        , 0
                        , 0
                        , 0
                        , 0
                        ]

            , test "chinese characters" <| \_ ->
                [ width "æ±‰"
                , width "å­—"
                , width "å­—"
                , width "/æ¼¢"
                ]
                    |> Expect.equalArrays
                        [ 2
                        , 2
                        , 2
                        , 3
                        ]

            , test "unicode arrows" <| \_ ->
                [ width <| "â†–"
                ]
                    |> Expect.equalArrays
                        [ 1
                        ]

            , test "unicode stars" <| \_ ->
                [ width <| "âœ¶"
                , width <| "âœ¸"
                , width <| "âœ¹"
                , width <| "âœº"
                , width <| "âœ¹"
                , width <| "âœ·"
                ]
                    |> Expect.equalArrays
                        [ 1
                        , 1
                        , 1
                        , 1
                        , 1
                        , 1
                        ]

            , test "misc emojis" <| \_ ->
                [ width <| "ðŸŒˆ"
                , width <| "â›„ï¸"
                , width <| "âœ¨"
                , width <| "ðŸ¤œ"
                , width <| "ðŸ¤›"
                , width <| "ðŸ¤›\u{FE0F}" -- emoji with a variation selector
                ]
                    |> Expect.equalArrays
                        [ 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        ]

            , test "unicode shapes" <| \_ ->
                [ width <| "ðŸŸ "
                , width <| "ðŸŸ¡"
                , width <| "ðŸŸ¢"
                , width <| "ðŸŸ£"
                , width <| "ðŸŸ¤"
                , width <| "ðŸŸ¥"
                , width <| "ðŸŸ¦"
                , width <| "ðŸŸ§"
                , width <| "ðŸŸ¨"
                , width <| "ðŸŸ©"
                , width <| "ðŸŸª"
                , width <| "ðŸŸ«"
                ]
                    |> Expect.equalArrays
                        [ 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        , 2
                        ]


            , test "shogi pieces" <| \_ ->
                [ width "â˜—"
                , width "â˜–"
                ]
                    |> Expect.equalArrays
                        [ 1
                        , 1
                        ]
                        
            , test "invisible characters that take up space" <| \_ ->
                [ width <| "\u{3000}" -- ideographic space
                ]
                    |> Expect.equalArrays
                        [ 2
                        ]
            
            , test "unicode hamburgers" <| \_ ->
                -- these visiually take up slightly more than one space,
                -- but spacially only take up a single space.
                [ width <| "â˜±"
                , width <| "â˜²"
                , width <| "â˜´"
                ]
                    |> Expect.equalArrays
                        [ 1
                        , 1
                        , 1
                        ]
            ]
